from fastmcp import FastMCP
import pandas as pd
import os

# Create the MCP server
mcp = FastMCP("DataAgent")

# The central folder for all your project files
BASE_DIR = r"C:\Users\dewni\Documents\my_mcp_project"

@mcp.tool()
def list_files():
    """Lists all data files (CSV, Excel, JSON) available in the project folder."""
    extensions = ('.csv', '.xlsx', '.xls', '.json')
    files = [f for f in os.listdir(BASE_DIR) if f.endswith(extensions)]
    return f"Files found: {', '.join(files)}" if files else "No supported data files found."

@mcp.tool()
def inspect_data(filename: str):
    """Shows column names, data types, and null counts for a file (Schema)."""
    path = os.path.join(BASE_DIR, filename)
    if not os.path.exists(path): return "Error: File not found."
    
    df = pd.read_csv(path) if filename.endswith('.csv') else pd.read_excel(path)
    # Creating a summary of the columns
    summary = []
    for col in df.columns:
        summary.append(f"Col: {col} | Type: {df[col].dtype} | Nulls: {df[col].isnull().sum()}")
    return "\n".join(summary)

@mcp.tool()
def read_data(filename: str, rows: int = 20):
    """Reads a file and returns the first few rows (Default 20)."""
    path = os.path.join(BASE_DIR, filename)
    if not os.path.exists(path): return "Error: File not found."
    
    df = pd.read_csv(path) if filename.endswith('.csv') else pd.read_excel(path)
    return df.head(rows).to_string()

@mcp.tool()
def calculate_pivots(filename: str, index_col: str, value_col: str, agg_func: str = "sum"):
    """Creates a pivot table summary. Example: index='Region', value='Sales', func='sum'."""
    path = os.path.join(BASE_DIR, filename)
    df = pd.read_csv(path) if filename.endswith('.csv') else pd.read_excel(path)
    
    # Perform the grouping (like a Pivot Table in Excel)
    result = df.groupby(index_col)[value_col].agg(agg_func).reset_index()
    return result.to_string()

@mcp.tool()
def merge_files(file1: str, file2: str, join_key: str):
    """Joins two files together using a common ID (Primary Key)."""
    path1 = os.path.join(BASE_DIR, file1)
    path2 = os.path.join(BASE_DIR, file2)
    
    df1 = pd.read_csv(path1) if file1.endswith('.csv') else pd.read_excel(path1)
    df2 = pd.read_csv(path2) if file2.endswith('.csv') else pd.read_excel(path2)
    
    # This is the 'VLOOKUP' or Power Query Merge equivalent
    merged_df = pd.merge(df1, df2, on=join_key, how='left')
    return merged_df.head(20).to_string()

@mcp.tool()
def clean_data(filename: str, fill_value: float = 0):
    """Fills missing (null) values in the 'Sales' column and saves as 'cleaned_data.csv'."""
    path = os.path.join(BASE_DIR, filename)
    if not os.path.exists(path): return "Error: File not found."
    
    df = pd.read_csv(path) if filename.endswith('.csv') else pd.read_excel(path)
    
    # Check if 'Sales' column exists
    if 'Sales' in df.columns:
        # Fill missing sales with the specified value (Power Query 'Replace Values')
        df['Sales'] = df['Sales'].fillna(fill_value)
        
    output_path = os.path.join(BASE_DIR, "cleaned_data.csv")
    df.to_csv(output_path, index=False)
    return f"Data cleaned! I saved the result as 'cleaned_data.csv' in your project folder."

if __name__ == "__main__":
    mcp.run()
